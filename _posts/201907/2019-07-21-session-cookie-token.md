---
layout: post
title:  "session, cookie及token的基本概念及应用场景"
categories: tech
img: 2019pics/http.jpg # Add image post (optional)
fig-caption: # Add figcaption (optional)
tags: [http, session, cookie, token]
excerpt: 随着互联网的发展，浏览器变得愈发重要，连带其使用的http协议，也变得愈发重要起来。本文准备对http在应用过程中的几个重要概念做一下拆分阐述。。
---


## SESSION和COOKIE的由来
众所周知，http是**无状态的**。这个无状态体现在，每次web服务器收到请求，都会认为是一个新的请求，处理的流程跟之前的请求没有任何关联。这样的好处是快，不需要进行额外的资源消耗。但坏处也明显，在多用户访问的时候就出现了问题：服务器需要记录用户的状态时，但是服务器无法区分出各个用户，或者说无法知道当前用户之前在服务器上做了什么操作--这样就引入了Session+Cookie的机制。用户所在的客户端访问网站所在的服务器的流程如下

* 客户端发送http请求到服务器。
* 服务器接收请求后，建立一个Session，并发送response到客户端。
* 如果是第一次登陆，返回的响应头中会有SessionId，客户端收到后，存在本地。
* 在客户端发起第二次请求时，如果服务器给了SessionId，则浏览器会自动在请求头中添加Cookie。
* 服务器接收请求，分析Cookie，根据业务逻辑进行操作并返回结果。

## ATTENTION
* 注意区分Session和Session的实现
>本来Session是一个抽象概念：开发者为了实现能够让服务端识别具体的用户，将客户端和服务端之间一对一的交互，抽象为**会话**，也就是Session。而我们今天说的Session，通常是指借助客户端的Cookie和服务器端的数据存储一起实现的，是一种具体的实现方式。
* Cookie只是实现Session的一个方案。其他的比如放到url中，每次请求服务器带上?SessionId=xxx也可以
* 用Session只需要在客户端保存一个id，Session相关的大量数据都保存在服务端，由于客户端每次传输都要带上Cookie，因此这样可以有效的减少带宽浪费。

## SESSION
#### 概念
>Session：在计算机中，尤其是在网络应用中，称为“会话控制”。Session对象存储特定用户会话所需的属性及配置信息。这样，当用户在应用程序的Web页之间跳转时，存储在Session对象中的变量将不会丢失，而是在整个用户会话中一直存在下去。当用户请求来自应用程序的 Web页时，如果该用户还没有会话，则Web服务器将自动创建一个 Session对象。当会话过期或被放弃后，服务器将终止该会话。Session 对象最常见的一个用法就是存储用户的首选项。

#### 应用场景
最典型的应用场景是购物车，当用户点击下单按钮的时候，由于http协议的无状态，所以服务器并不知道是哪个用户操作的，因此服务端要为特定的用户创建特定的Session，用于标识这个用户，并且跟踪用户行为，这样才知道购物车里到底有几本书。再比如权限管理，当用户在页面上进行某个具体操作的时候，服务端也是要通过Session去判断当前发起请求的对应的是系统中的哪个用户，从而知道当前用户所拥有的具体权限。

## COOKIE
#### 概念
>Cookie（复数形态Cookies），又称为“小甜饼”。类型为“小型文本文件”，指某些网站为了辨别用户身份而储存在用户本地终端（Client Side）上的数据（通常经过加密）。由网景公司的前雇员卢·蒙特利在1993年3月发明。最初定义于RFC 2109。当前使用最广泛的 Cookie标准却不是RFC中定义的任何一个，而是在网景公司制定的标准上进行扩展后的产物。

#### 应用场景
如定义中所说的，Cookie中一般保存的是用户首选项等一些定制化的信息。最常见的就是在电商网站中展示最近浏览的商品信息，如果Cookie设置了过期时间，那么当我们关闭浏览器后，在过期时间内打开指定网站，记录的信息仍旧有用。如果没有设置过期时间，关闭浏览器后，Cookie会自动失效。

## TOKEN

#### 由来
现有的Session+Cookie的认证方式，有几个无法规避的缺点
* 内存开销大
>Session是存在服务器上的，用户基数大的时候，所用内存的开销就会很大。即使改成redis，也是如此。
* 安全性问题
>因为是基于Cookie进行用户识别，如果Cookie被捕获，用户就很容易受到跨站请求（CSRF）伪造的攻击。
* 分布式的认证问题
>如果用户的Session是保存在服务器A上，但是下一次请求的时候，请求被转发到了服务器B，那么认证信息就失效了。

JWT（JSON Web Token）就很好的解决了上面的问题：
* token存放在客户端，不再增加服务端的开销。
* token可以设置一个有效时间，定时刷新，并将使用过的token加入黑名单。但这也导致了Cookie没法主动失效，一定要等到设置的有效时间到了才能失效
* token是基于数据库的认证，因此不需要进行web服务器的Session复制、共享等操作。

#### 概念
>JSON Web令牌（JWT）是一种紧凑的，URL安全的方式，用于表示要在双方之间转移的声明。 JWT中的声明被编码为JSON对象，用作JSON Web签名（JWS）结构的有效负载或JSON Web加密（JWE）结构的明文，使声明能够通过消息验证代码（MAC）和/或加密来获得数字签名或完整性保护。
>翻译自： [JSON Web Token(JWT)](https://tools.ietf.org/html/rfc7519)

#### 应用场景
JWT非常适用于REST API的场景，以及一些认证后需要进行跨域操作的流程中。

## 总结

* Session存在服务器上，通过Cookie中传过来的SessionId来识别当前的用户
* Cookie是大部分情况下浏览器在发送请求时会自动加上的数据，存在客户端，里面可以存放SessionId以及用户首选项等个性化信息
* token一般就是指JWT，是一个跨域的方案。用户信息都是以加密字符串的方式存在token中，每次请求时发给服务器，可以有效降低服务端的负载，而且增加了用户信息的安全性